<%# 階層ガイド: 標準の子チケット作成セクションを折り畳み風にするCSS/JS %>
<%
  # 設定が有効で、Epic Ladderモジュールが有効な場合のみ表示
  hierarchy_guide_enabled = Setting.plugin_redmine_epic_ladder['hierarchy_guide_enabled'] == '1'
  epic_ladder_enabled = @project&.module_enabled?(:epic_ladder)

  # トラッカーがEpic Ladder対象かチェック
  tracker_names = EpicLadder::TrackerHierarchy.tracker_names rescue {}
  is_epic_ladder_tracker = tracker_names.values.include?(@issue.tracker.name) if @issue && tracker_names.present?
%>

<% if hierarchy_guide_enabled && epic_ladder_enabled && is_epic_ladder_tracker %>
<style>
  /* 標準の子チケット作成セクションを折り畳み風に */
  #issue_tree {
    margin-top: 10px;
  }

  #issue_tree > .contextual {
    display: none;
  }

  /* バージョン変更リンクを非表示 */
  .attributes .issue-fixed-version .contextual,
  .attributes [data-attribute="fixed_version"] .contextual {
    display: none !important;
  }

  /* インラインエディットのバージョンフィールドにスタイル追加 */
  .attributes .issue-fixed-version .value,
  .attributes [data-attribute="fixed_version"] .value {
    position: relative;
  }

  /* 折り畳みコンテナ（非推奨の警告スタイル） */
  .epic-ladder-subtasks-wrapper {
    margin-top: 15px;
    border: 1px solid #ffcc80;
    border-left: 3px solid #ff9800;
    border-radius: 4px;
    background: #fff8e1;
  }

  .epic-ladder-subtasks-wrapper summary {
    padding: 10px 15px;
    cursor: pointer;
    color: #e65100;
    font-size: 13px;
    font-weight: bold;
    list-style: none;
  }

  .epic-ladder-subtasks-wrapper summary::-webkit-details-marker {
    display: none;
  }

  .epic-ladder-subtasks-wrapper summary::before {
    content: '⚠️ ';
    margin-right: 5px;
  }

  .epic-ladder-subtasks-wrapper[open] summary::before {
    content: '⚠️ ';
  }

  .epic-ladder-subtasks-wrapper .subtasks-content {
    padding: 10px 15px;
    border-top: 1px solid #ffcc80;
    background: #fffde7;
  }

  .epic-ladder-subtasks-wrapper .standard-subtask-link {
    display: inline-block;
    margin-top: 10px;
    padding: 5px 10px;
    background: #fff3e0;
    border: 1px solid #ffcc80;
    border-radius: 3px;
    color: #e65100;
    text-decoration: none;
    font-size: 12px;
  }

  .epic-ladder-subtasks-wrapper .standard-subtask-link:hover {
    background: #ffe0b2;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var issueTree = document.getElementById('issue_tree');
  if (!issueTree) return;

  // 元のsubtaskリンクを取得
  var contextual = issueTree.querySelector('.contextual');
  var subtaskLink = contextual ? contextual.querySelector('a') : null;

  // 折り畳みラッパーを作成
  var wrapper = document.createElement('details');
  wrapper.className = 'epic-ladder-subtasks-wrapper';

  var summary = document.createElement('summary');
  summary.textContent = '<%= j l(:label_epic_ladder_standard_operations) %>';
  wrapper.appendChild(summary);

  var content = document.createElement('div');
  content.className = 'subtasks-content';

  // 既存の子チケット一覧をコピー
  var existingContent = issueTree.innerHTML;
  content.innerHTML = existingContent;

  // 標準の子チケット作成リンクを追加（あれば）
  if (subtaskLink) {
    var linkClone = subtaskLink.cloneNode(true);
    linkClone.className = 'standard-subtask-link icon icon-add';
    content.appendChild(document.createElement('br'));
    content.appendChild(linkClone);
  }

  wrapper.appendChild(content);

  // 元のコンテンツを置き換え
  issueTree.innerHTML = '';
  issueTree.appendChild(wrapper);

  // バージョン変更セクションも折り畳みに移動
  var versionSection = document.querySelector('.issue-fixed-version');
  if (versionSection) {
    var versionContextual = versionSection.querySelector('.contextual');
    if (versionContextual) {
      var versionLinks = versionContextual.querySelectorAll('a');
      versionLinks.forEach(function(link) {
        var linkClone = link.cloneNode(true);
        linkClone.className = 'standard-subtask-link';
        linkClone.style.marginRight = '10px';
        content.appendChild(linkClone);
      });
      versionContextual.style.display = 'none';
    }
  }
});
</script>
<% end %>
