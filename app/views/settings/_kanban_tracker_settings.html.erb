<div class="box tabular settings">
  <h3>トラッカー設定</h3>
  <p class="description">
    各階層レベルに対応するトラッカー名を設定してください。<br>
    ここで設定したトラッカー名と一致するトラッカーがRedmineに存在する必要があります。
  </p>

  <div class="splitcontent">
    <div class="splitcontentleft">
      <fieldset class="box">
        <legend>階層トラッカー設定</legend>

        <p>
          <label for="settings_epic_tracker">Epic (レベル1)</label>
          <%= select_tag 'settings[epic_tracker]',
              options_from_collection_for_select(Tracker.sorted, :name, :name,
                                                 @settings['epic_tracker']),
              { include_blank: '-- 選択してください --', class: 'tracker-select' } %>
          <em class="info">最上位の大きな機能単位</em>
        </p>

        <p>
          <label for="settings_feature_tracker">Feature (レベル2)</label>
          <%= select_tag 'settings[feature_tracker]',
              options_from_collection_for_select(Tracker.sorted, :name, :name,
                                                 @settings['feature_tracker']),
              { include_blank: '-- 選択してください --', class: 'tracker-select' } %>
          <em class="info">機能単位（Epicの子要素）</em>
        </p>

        <p>
          <label for="settings_user_story_tracker">UserStory (レベル3)</label>
          <%= select_tag 'settings[user_story_tracker]',
              options_from_collection_for_select(Tracker.sorted, :name, :name,
                                                 @settings['user_story_tracker']),
              { include_blank: '-- 選択してください --', class: 'tracker-select' } %>
          <em class="info">ユーザー視点の要件（Featureの子要素）</em>
        </p>
      </fieldset>
    </div>

    <div class="splitcontentright">
      <fieldset class="box">
        <legend>実装トラッカー設定</legend>

        <p>
          <label for="settings_task_tracker">Task (レベル4)</label>
          <%= select_tag 'settings[task_tracker]',
              options_from_collection_for_select(Tracker.sorted, :name, :name,
                                                 @settings['task_tracker']),
              { include_blank: '-- 選択してください --', class: 'tracker-select' } %>
          <em class="info">実装タスク（UserStoryの子要素）</em>
        </p>

        <p>
          <label for="settings_test_tracker">Test (レベル4)</label>
          <%= select_tag 'settings[test_tracker]',
              options_from_collection_for_select(Tracker.sorted, :name, :name,
                                                 @settings['test_tracker']),
              { include_blank: '-- 選択してください --', class: 'tracker-select' } %>
          <em class="info">テストタスク（UserStoryの子要素）</em>
        </p>

        <p>
          <label for="settings_bug_tracker">Bug (レベル4)</label>
          <%= select_tag 'settings[bug_tracker]',
              options_from_collection_for_select(Tracker.sorted, :name, :name,
                                                 @settings['bug_tracker']),
              { include_blank: '-- 選択してください --', class: 'tracker-select' } %>
          <em class="info">バグ管理（UserStory/Featureの子要素）</em>
        </p>
      </fieldset>
    </div>
  </div>

  <fieldset class="box">
    <legend>階層構造プレビュー</legend>
    <div class="hierarchy-preview">
      <div class="hierarchy-level level-1">
        <strong id="epic-preview"><%= @settings['epic_tracker'] || 'Epic' %></strong>
        <div class="hierarchy-level level-2">
          └─ <strong id="feature-preview"><%= @settings['feature_tracker'] || 'Feature' %></strong>
          <div class="hierarchy-level level-3">
            └─ <strong id="user-story-preview"><%= @settings['user_story_tracker'] || 'UserStory' %></strong>
            <div class="hierarchy-level level-4">
              ├─ <span id="task-preview"><%= @settings['task_tracker'] || 'Task' %></span><br>
              ├─ <span id="test-preview"><%= @settings['test_tracker'] || 'Test' %></span><br>
              └─ <span id="bug-preview"><%= @settings['bug_tracker'] || 'Bug' %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </fieldset>
</div>

<script>
// 設定変更時にプレビューを更新
document.addEventListener('DOMContentLoaded', function() {
  const selects = document.querySelectorAll('.tracker-select');

  selects.forEach(function(select) {
    select.addEventListener('change', function() {
      const trackerType = this.name.replace('settings[', '').replace(']', '').replace('_tracker', '');
      const previewId = trackerType.replace('_', '-') + '-preview';
      const previewElement = document.getElementById(previewId);

      if (previewElement) {
        previewElement.textContent = this.value || this.name.split('[')[1].split('_')[0];
      }
    });
  });
});
</script>

<hr style="margin: 30px 0;">

<div class="box tabular settings">
  <h3>階層ガイド設定</h3>
  <p class="description">
    チケット詳細画面での階層操作ガイドを制御します。<br>
    有効にすると、標準の子チケット作成ボタンを折り畳み、クイックアクションを推奨します。
  </p>

  <fieldset class="box">
    <legend>表示設定</legend>
    <p>
      <label for="settings_hierarchy_guide_enabled">
        <%= check_box_tag 'settings[hierarchy_guide_enabled]', '1', @settings['hierarchy_guide_enabled'] == '1',
            id: 'settings_hierarchy_guide_enabled' %>
        階層ガイドを有効にする
      </label>
      <em class="info">
        有効時: 標準の「子チケット作成」を折り畳み、クイックアクションを強調表示します<br>
        無効時: 標準のRedmine動作のままになります
      </em>
    </p>
  </fieldset>

  <fieldset class="box">
    <legend>プラグイン統合設定</legend>
    <p>
      <label for="settings_dynamic_edit_integration_enabled">
        <%= check_box_tag 'settings[dynamic_edit_integration_enabled]', '1', @settings['dynamic_edit_integration_enabled'] == '1',
            id: 'settings_dynamic_edit_integration_enabled' %>
        Dynamic Editプラグイン統合を有効にする
      </label>
      <em class="info">
        有効時: redmine_issue_dynamic_edit プラグインと連携し、対象バージョンの編集をクイックアクションに統一します<br>
        無効時: Dynamic Editプラグインの標準動作のままになります
      </em>
    </p>
  </fieldset>
</div>

<hr style="margin: 30px 0;">

<div class="box tabular settings">
  <h3>MCP API設定</h3>
  <p class="description">
    MCP (Model Context Protocol) 経由でのAPI アクセスを制御します。<br>
    Claude Code等のAIツールからのアクセス許可を管理できます。
  </p>

  <fieldset class="box">
    <legend>グローバル設定</legend>
    <p>
      <label for="settings_mcp_enabled">
        <%= check_box_tag 'settings[mcp_enabled]', '1', @settings['mcp_enabled'] == '1',
            id: 'settings_mcp_enabled' %>
        MCP APIを有効にする
      </label>
      <em class="info">無効にするとすべてのMCPツール呼び出しが拒否されます</em>
    </p>
  </fieldset>

  <fieldset class="box">
    <legend>プロジェクト単位の設定</legend>
    <p class="description">
      プロジェクトごとのMCPアクセス許可は、各プロジェクトの設定画面で管理します。<br>
      プロジェクト設定 → 「Epic Ladder」タブ で設定できます。
    </p>
    <p class="mcp-project-info">
      <strong>💡 ヒント:</strong> プロジェクトでMCP APIを使用するには、<br>
      1. このグローバル設定でMCP APIを有効にする<br>
      2. 各プロジェクトの設定で「このプロジェクトでMCP APIを許可する」を有効にする
    </p>
  </fieldset>

  <fieldset class="box">
    <legend>MCPツールヒント（グローバルデフォルト）</legend>
    <p class="description">
      各MCPツール使用時にAIに伝えるルールを設定します。<br>
      プロジェクトで個別設定がない場合、この設定が使用されます。
    </p>

    <% mcp_tool_hints = @settings['mcp_tool_hints'] || {} %>
    <% EpicLadder::McpTools::Registry.modifying_tools_by_category_ordered.each do |category, tools| %>
      <div class="mcp-tool-category" style="margin: 15px 0;">
        <h4 style="background: #4a7298; color: #fff; padding: 8px 12px; margin: 0; font-size: 0.95em; border-radius: 4px 4px 0 0;">
          <%= I18n.t("epic_ladder.mcp_tool_categories.#{category}", default: category.to_s.titleize) %>
        </h4>
        <% tools.each do |tool_key| %>
          <% hint = mcp_tool_hints[tool_key] || {} %>
          <div class="mcp-tool-hint-row" style="border: 1px solid #ddd; border-top: none; padding: 10px 12px; background: #fafafa;">
            <div style="margin-bottom: 8px;">
              <label style="display: block;">
                <%= hidden_field_tag "settings[mcp_tool_hints][#{tool_key}][enabled]", '0' %>
                <%= check_box_tag "settings[mcp_tool_hints][#{tool_key}][enabled]", '1',
                    hint['enabled'] == '1' || hint['enabled'] == true,
                    id: "settings_mcp_tool_hint_#{tool_key}_enabled" %>
                <strong><%= I18n.t("epic_ladder.mcp_tools.#{tool_key}", default: tool_key.titleize) %></strong>
              </label>
            </div>
            <div>
              <%= text_area_tag "settings[mcp_tool_hints][#{tool_key}][hint_text]",
                  hint['hint_text'],
                  rows: 2,
                  style: 'width: 100%; font-size: 12px;',
                  placeholder: '例: PR必須、見積もり記載など',
                  maxlength: 500,
                  id: "settings_mcp_tool_hint_#{tool_key}_text" %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </fieldset>
</div>

<style>
.hierarchy-preview {
  background: #f8f8f8;
  border: 1px solid #ddd;
  padding: 15px;
  font-family: monospace;
  margin-top: 10px;
}

.hierarchy-level {
  margin-left: 20px;
  margin-top: 5px;
}

.hierarchy-level.level-1 {
  margin-left: 0;
}

.info {
  font-style: italic;
  color: #666;
  display: block;
  font-size: 0.9em;
  margin-top: 3px;
}

.mcp-project-info {
  padding: 10px;
  background: #e3f2fd;
  border: 1px solid #90caf9;
  border-radius: 4px;
  margin-top: 10px;
}
</style>