import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react';
import DHMLXGanttChart from '../../components/DHMLXGanttChart';
import { gantt } from 'dhtmlx-gantt';
import * as dhtmlxDataConverter from '../../utils/dhtmlxDataConverter';

// „É¢„ÉÉ„ÇØË®≠ÂÆö
jest.mock('dhtmlx-gantt');
jest.mock('../../utils/dhtmlxDataConverter');
jest.mock('../../templates/DHMLXCustomBar');
jest.mock('../../hooks/useZoomConfigDHMLX', () => ({
  useZoomConfigDHMLX: () => ({
    level: 'day',
    setLevel: jest.fn(),
    config: { scale_unit: 'day' }
  })
}));

// alert„ÅÆ„É¢„ÉÉ„ÇØ
global.alert = jest.fn();

describe('DHMLXGanttChart - „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ', () => {
  const mockTasks = [
    {
      id: 1,
      text: '„Çø„Çπ„ÇØ1',
      start: '2024-01-01',
      end: '2024-01-05',
      progress: 0.5,
      parent: 0,
      editable: true,
      issue_id: '123'
    }
  ];

  const defaultProps = {
    tasks: mockTasks,
    setTasks: jest.fn(),
    links: [],
    visibleColumns: [],
    onColumnSettingsChange: jest.fn(),
    projectId: 'test-project',
    filters: {},
    onFilterChange: jest.fn()
  };

  beforeEach(() => {
    jest.clearAllMocks();
    global.alert.mockClear();
    
    // „Éá„Éº„ÇøÂ§âÊèõ„É¢„ÉÉ„ÇØË®≠ÂÆö
    dhtmlxDataConverter.convertSvarToGantt.mockImplementation(tasks => 
      tasks.map(task => ({
        ...task,
        start_date: new Date(task.start),
        end_date: new Date(task.end)
      }))
    );
    
    // Gantt„É¢„ÉÉ„ÇØË®≠ÂÆö
    gantt.init.mockImplementation(() => {});
    gantt.parse.mockImplementation(() => {});
    gantt.clearAll.mockImplementation(() => {});
    gantt.attachEvent.mockImplementation(() => 1);
    gantt.exportToPDF.mockImplementation(() => {});
    gantt.exportToExcel.mockImplementation(() => {});
    gantt.exportToPNG.mockImplementation(() => {});
    gantt.exportToMSProject.mockImplementation(() => {});
  });

  describe('F005: „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ', () => {
    it('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éú„Çø„É≥„ÅåÊ≠£„Åó„ÅèË°®Á§∫„Åï„Çå„Çã', () => {
      render(<DHMLXGanttChart {...defaultProps} />);
      
      expect(screen.getByText('üìÑ PDF')).toBeInTheDocument();
      expect(screen.getByText('üìä Excel')).toBeInTheDocument();
      expect(screen.getByText('üñºÔ∏è PNG')).toBeInTheDocument();
      expect(screen.getByText('üìã MS Project')).toBeInTheDocument();
    });

    it('PDF„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÊ≠£„Åó„ÅèÊ©üËÉΩ„Åô„Çã', () => {
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const pdfButton = screen.getByText('üìÑ PDF');
      fireEvent.click(pdfButton);
      
      expect(gantt.exportToPDF).toHaveBeenCalledWith({
        name: expect.stringMatching(/gantt_chart_\d{4}-\d{2}-\d{2}\.pdf/),
        header: expect.stringContaining('Gantt Chart'),
        footer: expect.stringContaining('Generated by Redmine React Gantt Chart'),
        locale: 'jp',
        raw: true,
        skin: 'dhtmlx_gantt_default'
      });
    });

    it('Excel„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÊ≠£„Åó„ÅèÊ©üËÉΩ„Åô„Çã', () => {
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const excelButton = screen.getByText('üìä Excel');
      fireEvent.click(excelButton);
      
      expect(gantt.exportToExcel).toHaveBeenCalledWith({
        name: expect.stringMatching(/gantt_chart_\d{4}-\d{2}-\d{2}\.xlsx/),
        columns: expect.arrayContaining([
          expect.objectContaining({ id: 'id', header: 'ID' }),
          expect.objectContaining({ id: 'text', header: '„Çø„Çπ„ÇØÂêç' }),
          expect.objectContaining({ id: 'tracker_name', header: '„Éà„É©„ÉÉ„Ç´„Éº' }),
          expect.objectContaining({ id: 'status_name', header: '„Çπ„ÉÜ„Éº„Çø„Çπ' }),
          expect.objectContaining({ id: 'assigned_to_name', header: 'ÊãÖÂΩìËÄÖ' }),
          expect.objectContaining({ id: 'start_date', header: 'ÈñãÂßãÊó•' }),
          expect.objectContaining({ id: 'end_date', header: 'ÁµÇ‰∫ÜÊó•' }),
          expect.objectContaining({ id: 'duration', header: 'ÊúüÈñì' }),
          expect.objectContaining({ id: 'progress', header: 'ÈÄ≤Êçó' })
        ]),
        visual: true,
        rawDates: false
      });
    });

    it('PNG„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÊ≠£„Åó„ÅèÊ©üËÉΩ„Åô„Çã', () => {
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const pngButton = screen.getByText('üñºÔ∏è PNG');
      fireEvent.click(pngButton);
      
      expect(gantt.exportToPNG).toHaveBeenCalledWith({
        name: expect.stringMatching(/gantt_chart_\d{4}-\d{2}-\d{2}\.png/),
        raw: true,
        skin: 'dhtmlx_gantt_default'
      });
    });

    it('MS Project„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÊ≠£„Åó„ÅèÊ©üËÉΩ„Åô„Çã', () => {
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const msProjectButton = screen.getByText('üìã MS Project');
      fireEvent.click(msProjectButton);
      
      expect(gantt.exportToMSProject).toHaveBeenCalledWith({
        name: expect.stringMatching(/gantt_chart_\d{4}-\d{2}-\d{2}\.xml/),
        project: {
          'Author': 'Redmine React Gantt Chart',
          'Title': 'Project Schedule',
          'Company': 'Your Company'
        }
      });
    });

    it('PDF„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„ÉºÊôÇ„Å´„Ç¢„É©„Éº„Éà„ÅåË°®Á§∫„Åï„Çå„Çã', () => {
      gantt.exportToPDF.mockImplementation(() => {
        throw new Error('PDF export failed');
      });
      
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const pdfButton = screen.getByText('üìÑ PDF');
      fireEvent.click(pdfButton);
      
      expect(global.alert).toHaveBeenCalledWith('PDF„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
    });

    it('Excel„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„ÉºÊôÇ„Å´„Ç¢„É©„Éº„Éà„ÅåË°®Á§∫„Åï„Çå„Çã', () => {
      gantt.exportToExcel.mockImplementation(() => {
        throw new Error('Excel export failed');
      });
      
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const excelButton = screen.getByText('üìä Excel');
      fireEvent.click(excelButton);
      
      expect(global.alert).toHaveBeenCalledWith('Excel„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
    });

    it('PNG„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„ÉºÊôÇ„Å´„Ç¢„É©„Éº„Éà„ÅåË°®Á§∫„Åï„Çå„Çã', () => {
      gantt.exportToPNG.mockImplementation(() => {
        throw new Error('PNG export failed');
      });
      
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const pngButton = screen.getByText('üñºÔ∏è PNG');
      fireEvent.click(pngButton);
      
      expect(global.alert).toHaveBeenCalledWith('PNG„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
    });

    it('MS Project„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„ÉºÊôÇ„Å´„Ç¢„É©„Éº„Éà„ÅåË°®Á§∫„Åï„Çå„Çã', () => {
      gantt.exportToMSProject.mockImplementation(() => {
        throw new Error('MS Project export failed');
      });
      
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const msProjectButton = screen.getByText('üìã MS Project');
      fireEvent.click(msProjectButton);
      
      expect(global.alert).toHaveBeenCalledWith('MS Project„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
    });

    it('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éï„Ç°„Ç§„É´Âêç„Å´Êó•‰ªò„ÅåÂê´„Åæ„Çå„Çã', () => {
      const mockDate = new Date('2024-03-15');
      jest.spyOn(Date, 'now').mockReturnValue(mockDate.getTime());
      jest.spyOn(global, 'Date').mockImplementation(() => mockDate);
      
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const pdfButton = screen.getByText('üìÑ PDF');
      fireEvent.click(pdfButton);
      
      expect(gantt.exportToPDF).toHaveBeenCalledWith(
        expect.objectContaining({
          name: 'gantt_chart_2024-03-15.pdf'
        })
      );
    });

    it('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éú„Çø„É≥„Å´„Éõ„Éê„Éº„Çπ„Çø„Ç§„É´„ÅåÈÅ©Áî®„Åï„Çå„Çã', () => {
      const { container } = render(<DHMLXGanttChart {...defaultProps} />);
      
      // „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„ÅåÈÅ©Áî®„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
      const exportToolbar = container.querySelector('.export-toolbar');
      expect(exportToolbar).toBeInTheDocument();
      
      const exportButtons = container.querySelectorAll('.export-btn');
      expect(exportButtons).toHaveLength(4);
      
      // ÂêÑ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„ÇØ„É©„Çπ„ÇíÁ¢∫Ë™ç
      expect(exportButtons[0]).toHaveClass('export-btn-pdf');
      expect(exportButtons[1]).toHaveClass('export-btn-excel');
      expect(exportButtons[2]).toHaveClass('export-btn-png');
      expect(exportButtons[3]).toHaveClass('export-btn-msproject');
    });

    it('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éú„Çø„É≥„Å´„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã', () => {
      render(<DHMLXGanttChart {...defaultProps} />);
      
      const pdfButton = screen.getByText('üìÑ PDF');
      const excelButton = screen.getByText('üìä Excel');
      const pngButton = screen.getByText('üñºÔ∏è PNG');
      const msProjectButton = screen.getByText('üìã MS Project');
      
      expect(pdfButton).toHaveAttribute('title', 'PDF„Ç®„ÇØ„Çπ„Éù„Éº„Éà');
      expect(excelButton).toHaveAttribute('title', 'Excel„Ç®„ÇØ„Çπ„Éù„Éº„Éà');
      expect(pngButton).toHaveAttribute('title', 'PNG„Ç®„ÇØ„Çπ„Éù„Éº„Éà');
      expect(msProjectButton).toHaveAttribute('title', 'MS Project„Ç®„ÇØ„Çπ„Éù„Éº„Éà');
    });

    it('„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ„Ååwindow.ganttApiÁµåÁî±„Åß„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Çã', () => {
      render(<DHMLXGanttChart {...defaultProps} />);
      
      // window.ganttApi„Å´„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ„ÅåÂÖ¨Èñã„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
      expect(window.ganttApi).toHaveProperty('exportToPDF');
      expect(window.ganttApi).toHaveProperty('exportToExcel');
      expect(window.ganttApi).toHaveProperty('exportToPNG');
      expect(window.ganttApi).toHaveProperty('exportToMSProject');
      
      // APIÁµåÁî±„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÇíÂÆüË°å
      window.ganttApi.exportToPDF();
      expect(gantt.exportToPDF).toHaveBeenCalled();
      
      window.ganttApi.exportToExcel();
      expect(gantt.exportToExcel).toHaveBeenCalled();
      
      window.ganttApi.exportToPNG();
      expect(gantt.exportToPNG).toHaveBeenCalled();
      
      window.ganttApi.exportToMSProject();
      expect(gantt.exportToMSProject).toHaveBeenCalled();
    });
  });
});