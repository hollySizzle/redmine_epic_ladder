# AIエージェント協働規約

<!-- ドキュメント参照規約:  形式を使用（doc/からの相対パス、../は禁止） -->

## 📋 目次
- [AIエージェント協働規約](#aiエージェント協働規約) (L1-248)
  - [🔗 関連ドキュメント](#-関連ドキュメント) (L35-39)
  - [1. 基本方針](#1-基本方針) (L41-50)
    - [1.1 目的](#11-目的) (L43-44)
    - [1.2 原則](#12-原則) (L46-50)
  - [2. 設計書階層と責任分界](#2-設計書階層と責任分界) (L52-83)
    - [2.1 外部設計書（/myapp/doc）](#21-外部設計書myappdoc) (L54-65)
    - [2.2 Rails設定YAML（config/）](#22-rails設定yamlconfig) (L67-75)
    - [2.3 内部設計書（vibes/docs）](#23-内部設計書vibesdocs) (L77-83)
  - [3. AIエージェント権限規定](#3-aiエージェント権限規定) (L85-135)
    - [3.1 自立実行可能範囲](#31-自立実行可能範囲) (L87-101)
    - [3.2 要相談範囲（許可後は実行可能）](#32-要相談範囲許可後は実行可能) (L103-117)
    - [3.3 絶対禁止範囲](#33-絶対禁止範囲) (L119-124)
    - [3.4 微調整の定義](#34-微調整の定義) (L126-135)
  - [4. 協働フロー](#4-協働フロー) (L137-178)
    - [4.1 Phase 1: 設計フェーズ](#41-phase-1-設計フェーズ) (L139-145)
    - [4.2 Phase 2: 実装設計フェーズ](#42-phase-2-実装設計フェーズ) (L147-153)
    - [4.3 Phase 3: 実装フェーズ](#43-phase-3-実装フェーズ) (L155-161)
    - [4.4 Phase 4: 手動検証フェーズ](#44-phase-4-手動検証フェーズ) (L163-169)
    - [4.5 Phase 5: BDD移行フェーズ](#45-phase-5-bdd移行フェーズ) (L171-178)
  - [5. 手動テストとBDD移行](#5-手動テストとbdd移行) (L180-203)
    - [5.1 手動テストの定義](#51-手動テストの定義) (L182-189)
    - [5.2 BDD移行計画](#52-bdd移行計画) (L191-203)
  - [6. エラー時エスカレーション・トラブルシューティング](#6-エラー時エスカレーショントラブルシューティング) (L205-218)
    - [6.1 主なエラータイプ](#61-主なエラータイプ) (L211-218)
  - [7. 実装例・チェックリスト](#7-実装例チェックリスト) (L220-239)
    - [7.1 主な実装例](#71-主な実装例) (L226-230)
    - [7.2 チェックリスト概要](#72-チェックリスト概要) (L232-239)
  - [関連ドキュメント](#関連ドキュメント) (L241-248)
## 🔗 関連ドキュメント
- @vibes/rules/technical_architecture_standards.md
- @vibes/rules/design_compliance_standards.md
- @vibes/rules/coding_standards.md
- @vibes/tasks/presenter_development.md

## 1. 基本方針

### 1.1 目的
AIエージェントとプロジェクトオーナーの効率的な協働体制を確立し、設計書準拠の高品質な開発を実現する。

### 1.2 原則
- **important**: 
AIエージェントは選択肢がある場合は必ずオーナに選択肢を提示し､オーナーの指示を仰ぐこと｡その際は各選択肢のpro/conを提示すること
- **設計書最優先**: 外部設計書を実装の根拠とし、準拠を徹底する
- **責任分界明確化**: AIとオーナーの役割を明確に定義し、効率的な分業を実現

## 2. 設計書階層と責任分界

### 2.1 外部設計書（/myapp/doc）

**責任者**: プロジェクトオーナー  
**AIエージェント権限**: 編集不可、手動での微調整は可

| 設計書種別 | パス | 役割 |
|------------|------|------|
| 機能リスト | `/myapp/Doc/400_画面設計/_機能リスト.json` | Railsメソッド定義、権限管理 |
| 帳票リスト | `/myapp/Doc/300_帳票/_帳票リスト.json` | 実務帳票定義 |
| シーケンス図 | `/myapp/Doc/200_シーケンス図/05_システム導入後フロー/*.pu` | 業務フロー、画面遷移定義 |
| ER図 | `/myapp/Doc/500_DB設計/ER図/*.pu` | DB全体設計 |
| テーブル詳細設計 | `/myapp/Doc/500_DB設計/sql/*.sql` | 個別テーブル定義 |

### 2.2 Rails設定YAML（config/）

**責任者**: プロジェクトオーナー  
**AIエージェント権限**: 編集不可、手動での微調整は可

| YAML種別 | パス | 役割 |
|----------|------|------|
| ボタン定義YAML | `config/buttons/*_buttons.yml` | 各viewのボタン定義 |
| 表示項目定義YAML | `config/presenters/*_fields.yml` | 表示項目、検索条件、バリデーション定義 |

### 2.3 内部設計書（vibes/docs）

**責任者**: AIエージェント主導、オーナー承認  
**AIエージェント権限**: 自立的作成・更新可能

- 機能設計書
- 実装設計書

## 3. AIエージェント権限規定

### 3.1 自立実行可能範囲

```yaml
config/presenters/*_fields.yml:
  許可範囲:
    - label文言修正
    - order値調整（既存範囲内）
    - display: true/false 切り替え
  
Rails実装:
  許可範囲:
    - Controller/Model/View実装
    - テスト実装
    - 既存アーキテクチャに準拠した実装
```

### 3.2 要相談範囲（許可後は実行可能）

```yaml
config/presenters/*_fields.yml:
  要相談事項:
    - validation追加・変更
    - 新規フィールド追加
    - overrides設定変更（権限管理影響）
  
config/buttons/*_buttons.yml:
  要相談事項:
    - 新規ボタン追加（機能ID発番必要）
    - ボタン機能ID変更
    - ボタン動作変更（シーケンス図変更伴う）
```

### 3.3 絶対禁止範囲

- 外部設計書（/myapp/doc）の変更
- 機能リスト.jsonにない機能の実装
- シーケンス図と異なる画面遷移の実装
- 基幹クラス（app/presenters/concerns/presenter/）への業務ロジック混入

### 3.4 微調整の定義

**微調整OK**: 
- YAML内の既存項目の値変更（display、order、label）
- 実装済み機能の軽微な改善

**微調整NG**:
- 新規項目追加
- 構造的変更
- 設計書と異なる実装

## 4. 協働フロー

### 4.1 Phase 1: 設計フェーズ

**責任者**: オーナー主導、AIサポート

1. **オーナー**: 機能リスト.json → シーケンス図 → テーブル設計
2. **AIエージェント**: 参照して機能設計書叩き台作成
3. **チェックポイント**: オーナーによる機能設計書承認

### 4.2 Phase 2: 実装設計フェーズ

**責任者**: AIエージェント主導

1. **AIエージェント**: 実装設計書作成 + YAML変更計画提示
2. **チェックポイント**: オーナーによるYAML変更許可
3. **成果物**: 承認済み実装設計書

### 4.3 Phase 3: 実装フェーズ

**責任者**: AIエージェント自立

1. **AIエージェント**: Rails実装（Controller/Model/View/Test）
2. **自動チェック**: rubocop、テスト実行、設計書準拠性確認
3. **成果物**: 動作する実装

### 4.4 Phase 4: 手動検証フェーズ

**責任者**: オーナー

1. **オーナー**: 実際の画面操作で実装方向性確認
2. **フィードバック**: 具体的修正指示
3. **ループ**: 必要に応じてPhase 3に戻る

### 4.5 Phase 5: BDD移行フェーズ

**責任者**: AIエージェント主導

**移行条件**: 手動テストでの大きな方向性修正が不要になった段階

1. **AIエージェント**: E2E/BDDテスト強化
2. **移行完了**: 手動テスト頻度削減、BDDが品質保証の主体

## 5. 手動テストとBDD移行

### 5.1 手動テストの定義

**目的**: プロジェクトオーナーが実際の画面を操作し、実装の方向性を確認すること

**対象**: 
- 新機能の業務フロー確認
- UI/UXの使いやすさ検証
- 想定される利用パターンの動作確認

### 5.2 BDD移行計画

**移行フェーズ1（並行期間）**:
- 手動テスト: 重要業務フロー確認
- BDDテスト: 既存機能の回帰テスト強化

**移行フェーズ2（段階的削減）**:
- 手動テスト: 新機能・重要変更のみ
- BDDテスト: 全機能カバー

**移行フェーズ3（完全移行）**:
- 手動テスト: 月1回程度の確認
- BDDテスト: 継続的品質保証の主体

## 6. エラー時エスカレーション・トラブルシューティング

エラー発生時の対応手順は以下を参照：

**詳細ドキュメント**: @vibes/rules/ai_collaboration_troubleshooting.md

### 6.1 主なエラータイプ

- 設計書不整合発見時 → 作業即座停止
- 自動テスト失敗継続時 → 3回連続失敗で一旦停止
- YAML変更権限不明時 → 変更内容を具体的に説明
- 前提条件不足エラー → 必要情報の確認を依頼
- Presenter未存在エラー → scaffold_presenterジェネレータ実行
- 参照整合性エラー → ドキュメント参照チェック実行

## 7. 実装例・チェックリスト

実装例やチェックリストの詳細は以下を参照：

**詳細ドキュメント**: @vibes/rules/ai_collaboration_examples_checklists.md

### 7.1 主な実装例

- 権限内での自立実行例 (YAML label修正、order調整等)
- 要相談事項の例 (新規バリデーション追加、新規ボタン追加等)
- エスカレーション実行例 (設計書不整合発見時の報告等)

### 7.2 チェックリスト概要

- 事前チェック: 要件確認、環境整備、重複確認
- 実装前チェック: 設計書確認、権限確認、アーキテクチャ整合性
- 実装後チェック: 各フェーズ成果物確認、テスト実行
- 品質チェック: コード規約準拠、セキュリティ、パフォーマンス
- 技術実装後チェック: 設計書準拠性、テスト、権限確認
- エスカレーション判断チェック: 設計書整合性、権限範囲、テスト結果

## 関連ドキュメント

- [技術アーキテクチャ規約](@vibes/rules/technical_architecture_standards.md)
- [AIエージェント協働トラブルシューティング](@vibes/rules/ai_collaboration_troubleshooting.md)
- [AIエージェント協働実装例・チェックリスト](@vibes/rules/ai_collaboration_examples_checklists.md)
- [設計書準拠規約](@vibes/rules/design_compliance_standards.md)
- [コーディング規約](@vibes/rules/coding_standards.md)
- [Presenter開発ガイド](@vibes/tasks/presenter_development.md)